# MessageAI ‚Äì Sprint 2 AI Integration Task Plan (LangChain, Kotlin)

**Total focus:** AI module + Geo integration + Reporting + CASEVAC agent  
**Parallelization:** 3‚Äì4 blocks at once; maintain dependency order  

---

## üî¥ BLOCK A: AI Core Module
**Dependencies:** None  
**Time:** ~3‚Äì4h  
**Critical path:** yes

**Tasks**
- [ ] Create `/modules/ai` package and scaffolding  
- [ ] Define `IAIProvider` interface and `AIService` facade  
- [ ] Implement dependency injection with Hilt bindings  
- [ ] Implement base providers:  
  - [ ] `OpenAIProvider` ‚Üí Firebase Function call (optional simple prompts)  
  - [ ] `LocalProvider` ‚Üí mock responses for offline testing  
- [ ] Create RAG context builder (fetch last 50 messages from Room for context)  
- [ ] Add secure token handling via Android Keystore  
- [ ] Add WorkManager task type for queued AI operations  
- [ ] Add **LangChain workflow adapter** (HTTP client + JSON contracts)  
- [ ] Implement `runLangChainWorkflow(endpoint, payload)` in AIService  

**Acceptance**
- [ ] AIService returns valid responses from LangChain proxy  
- [ ] Hilt bindings compile and resolve at runtime  
- [ ] Keystore-secured tokens verified functional  
- [ ] AI operations queue when offline and replay on reconnect  
- [ ] Workflow adapter successfully triggers LangChain RAG/agent workflow

---

## üü• BLOCK B: Firebase Function Proxy
**Dependencies:** A  
**Time:** ~2h  

**Tasks**
- [ ] Create Cloud Function: `/functions/aiRouter`  
- [ ] Routes requests to **LangChain service** endpoints  
- [ ] Validates and sanitizes inputs, signs responses  
- [ ] Returns JSON payload (message, intent, confidence, data)  
- [ ] Add rate-limiting and error fallback  
- [ ] Configurable `LANGCHAIN_BASE_URL` for DoD/on-prem swap

**Acceptance**
- [ ] AI requests succeed round-trip via Firebase  
- [ ] Errors handled gracefully with retry in client queue  
- [ ] No API keys exposed to client  
- [ ] Contract test: CF proxy request/response matches LangChain schema

---

## üü• BLOCK B2: LangChain Service (Python)
**Dependencies:** A  
**Time:** ~5h  

**Tasks**
- [ ] Bootstrap FastAPI/Flask service with endpoints:
  - [ ] `POST /template/generate`
  - [ ] `POST /threats/extract`
  - [ ] `POST /sitrep/summarize`
  - [ ] `POST /intent/casevac/detect`
  - [ ] `POST /workflow/casevac/run`
- [ ] Implement RAG retrieval over Firestore (server-side) with simple embeddings cache
- [ ] Add tool functions: geo parsing, facility lookup, time-window message fetch
- [ ] Containerize (Dockerfile), env-based config, health checks
- [ ] Observability: requestId propagation, structured logs, latency metrics

**Acceptance**
- [ ] Endpoints return valid JSON per contract
- [ ] RAG retrieval works against sample Firestore dataset
- [ ] P95 latency: <2s (simple), <8s (agent); warm container
- [ ] Service runs locally via Docker and behind CF proxy

---

## üüß BLOCK C: Geolocation Intelligence & Threat Alerts
**Dependencies:** A, B  
**Time:** ~3h  

**Tasks**
- [ ] Create `/modules/geo` package and `GeoService.kt`  
- [ ] Implement location extraction using `AIService.extractGeoData()`  
- [ ] Create Firestore listener for user presence and signal status  
- [ ] Integrate `NotificationManager` for signal loss events  
- [ ] Implement geofence monitoring with WorkManager  
- [ ] Add map layer for displaying threat zones  
- [ ] Implement **AI-based threat summarization** via LangChain `/threats/extract`

**Acceptance**
- [ ] Signal loss alerts fire within 10s  
- [ ] Threat summaries generated by LangChain workflow  
- [ ] Geo-extraction from messages ‚â• 90% accuracy  
- [ ] Alerts trigger entering geofenced areas  

---

## üü® BLOCK D: Template Generation & SITREP Reporting
**Dependencies:** A, B, B2  
**Time:** ~4h  

**Tasks**
- [ ] Add `/modules/reporting` and `ReportService.kt`  
- [ ] Implement `generateTemplate()` for NATO forms via LangChain `/template/generate`  
- [ ] Create `generateSITREP()` via LangChain `/sitrep/summarize`  
- [ ] Integrate Coil + ReportLab for in-app PDF rendering  
- [ ] Add share-to-chat functionality  
- [ ] Update README with endpoint specs  

**Acceptance**
- [ ] Template auto-fill accuracy ‚â• 80%  
- [ ] SITREP generation < 10s (including AI summarization)  
- [ ] Reports exportable offline  
- [ ] Works with both live and cached message data  
- [ ] LangChain workflow successfully invoked (logged `requestId`)  

---

## üü© BLOCK E: Mission Tracker & Dashboard
**Dependencies:** A, B, D  
**Time:** ~3h  

**Tasks**
- [ ] Implement `AIService.extractTasks()` for objective parsing  
- [ ] Add Firestore `missions` collection schema  
- [ ] Create Compose `MissionBoard` with real-time updates  
- [ ] Add task cards for personnel status and assignments  
- [ ] Add optional filters: by squad, priority, or timestamp  

**Acceptance**
- [ ] Dashboard updates within 2s of chat change  
- [ ] Task extraction precision ‚â• 85%  
- [ ] Filters functional and reactive  

---

## üü™ BLOCK F: CASEVAC Agent Workflow
**Dependencies:** A, B, C, D, E  
**Time:** ~5h  

**Tasks**
- [ ] Implement `AIService.detectCasevacIntent(messages)` ‚Üí LangChain `/intent/casevac/detect`  
- [ ] Build workflow runner: `AIService.runWorkflow("casevac")` ‚Üí LangChain `/workflow/casevac/run`  
- [ ] Sequence 9-line generation ‚Üí facility lookup ‚Üí mission entry ‚Üí status update  
- [ ] Integrate WorkManager orchestration for multi-step tasks  
- [ ] Add retry/backoff logic  
- [ ] Create Compose ‚ÄúCASEVAC Monitor‚Äù screen (shows step state)  

**Acceptance**
- [ ] Agent performs 5+ steps autonomously in < 60s  
- [ ] No keyword-based logic; intent detection handled by AI inference  
- [ ] Workflow persists if app closed mid-sequence  
- [ ] Mission Tracker updates in real-time  
- [ ] CASEVAC pipeline integrated through **LangChain** adapter

---

## üü´ BLOCK G: Testing & Validation
**Dependencies:** A‚ÄìF  
**Time:** ~3‚Äì4h  

**Tasks**
- [ ] Run latency/accuracy benchmarks for all AI endpoints  
- [ ] Warm vs cold start latency comparison for LangChain service  
- [ ] Offline/queue tests using airplane mode  
- [ ] CASEVAC workflow end-to-end validation  
- [ ] SITREP accuracy comparison vs manual reports  
- [ ] Stress test 50 concurrent AI tasks  
- [ ] Generate log summaries for rubric submission  

**Acceptance**
- [ ] All AI calls stable and performant  
- [ ] Queued operations replay correctly after reconnect  
- [ ] Advanced CASEVAC workflow meets rubric targets  
- [ ] Accuracy ‚â• 85%, latency < 2s for most features  

---

## üü¶ BLOCK H: Packaging & Delivery
**Dependencies:** G  
**Time:** ~1‚Äì2h  

**Tasks**
- [ ] Build signed APK for submission  
- [ ] Update README with AI architecture & LangChain provider-swap documentation  
- [ ] Add AI workflow diagram + LangChain endpoints to docs  
- [ ] Final lint + compose tests  
- [ ] Record demo video (show all AI features)  

**Acceptance**
- [ ] APK installable and demo-ready  
- [ ] README explains Firebase ‚Üí DoD (LangChain) swap  
- [ ] Video demonstrates all required AI features, LangChain-backed agent flow, and observability metrics  

---

## üìä ASCII Diagram: AI‚ÄìMessage‚ÄìWorkflow Overview
```
            +------------------+
            |  User Message UI |
            +------------------+
                      |
                      v
              +---------------+
              |   AIService   |<-------------------+
              +---------------+                    |
          /|\        |                             |
           |         |                             |
           |   (Hilt DI)                           |
           |         |                             |
+------------------+  |   +-------------------+     |
|  IAIProvider     |--+-->| LangChainAdapter  |     |
+------------------+      +-------------------+     |
     ^     ^                                          |
     |     |                                          |
     |     +--------------+---------------------------+
     |                    |
     |        +------------------------+
     |        | Local/OpenAIProvider   |
     |        +------------------------+
     |
     |   (Responses)
     v
+-------------------+
|  AIFeatureLogic   | <------------------------------+
+-------------------+                                |
 |   |   |   |                                       |
 |   |   |   +----> GeoService (Threat Zones)        |
 |   |   +--------> ReportService (SITREP / Templates)|
 |   +------------> MissionTracker                   |
 +----------------> CASEVAC Agent (Multi-Step)       |
```

---

## üèÅ Recommended Execution Order
**Day 1:** A, B ‚Üí Core AI pipeline operational  
**Day 2:** B2 ‚Üí LangChain service endpoints live  
**Day 3:** C, D ‚Üí Geo + Reporting integrated  
**Day 4:** E ‚Üí Mission Dashboard  
**Day 5:** F ‚Üí CASEVAC multi-step agent  
**Day 6:** G ‚Üí Full validation and testing  
**Day 7:** H ‚Üí Packaging + submission  
